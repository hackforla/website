<style>
  a.filter-item {
    text-decoration: none;
  }

  nav {
    font-family: monospace;
  }

  ul.filter-list {
    background: lightgray;
    list-style: none;
    margin: 0;
    padding-left: 0;
  }

  li.filter-item {
    border: 1px solid black;
    color: black;
    background: lightgray;
    display: block;
    float: left;
    padding: 1rem 3rem;
    position: relative;
    text-decoration: none;
    transition-duration: 0.5s;
  }

  li.filter-item a {
    color: black;
  }

  li.filter-item:hover,
  li.filter-item:focus-within {
    background: grey;
    cursor: pointer;
  }

  li.filter-item:focus-within a {
    outline: none;
  }

  ul.filter-list li ul {
    background: lightgray;
    visibility: hidden;
    opacity: 0;
    min-width: 5rem;
    position: absolute;
    transition: all 0.5s ease;
    margin-top: 1rem;
    left: 0;
    display: none;
    z-index: 1;
  }

  ul.filter-list li:hover>ul,
  ul.filter-list li:focus-within>ul,
  ul.filter-list li ul:hover,
  ul.filter-list li ul:focus {
    visibility: visible;
    opacity: 1;
    display: block
  }

  ul.filter-list li ul li {
    clear: both;
    width: 100%;
    text-align: left;
  }

  .hidden-project {
    display: none;
  }
</style>

<a class="anchor" id="projects"></a>
<section class="content-section projects">

  <div class="page-contain projects-inner">
    <h2 class="project-header">Current Projects</h2>
    <p class="project-pitch">
      Have an idea? <a href="mailto:team@hackforla.org" class="btn btn-primary">Submit your pitch</a>
    </p>
  </div>

  <div class="page-contain filter-toolbar" style="text-align: center;">
    <ul class="filter-list" id="filter-list">
    </ul>

  </div>
  <div class="page-contain projects-inner" style="clear: left;">
    <ul class="project-list unstyled-list">
      {% assign status_list = "Active, Rebooting, Completed, On Hold" | split: ", " %}
      {% for status in status_list %}
        {% assign projects = site.projects | where: "status", status | sort: "title" %}
        {%- for item in projects -%}
          {%- if item.hide != true -%}
            {%- include project-card.html project=item -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endfor -%}
    </ul>
  </div>
</section>

<script>

  {% assign p = site.data.data | jsonify %}
  let projectData = {{ p }};


  // demo random categories
  // const filterCategories = ['languages', 'color', 'size', 'origin']

  const filterCategories = ['languages']

  window.addEventListener('load', function () {

    // utilities
    const cleanFieldName = (category, term) => `${category}_${term.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '')}`;

    // Add project data to encapsulated objects compatible with filtering library
    const projects = projectData.map(project => {

      let record = filterCategories.reduce((rec, cur) => {
        rec[cur] = project[cur]['data'];
        return rec;
      }, {});

      record['id'] = project['id'];

      return new Project(record)

    });

    // Collect all possible filter values for count computation
    const valuesByCategory = new Map();
    projects.forEach(p => {
      for (let key in p.data) {
        if (key === 'id') {
          continue;
        }
        if (!valuesByCategory.has(key)) {
          valuesByCategory.set(key, new Set());
        }
        for (let v in p.data[key]) {
          valuesByCategory.get(key).add(p.data[key][v]);

        }
      }
    });

    // initialize project filter and get initial report (no filters applied yet)
    const projectFilter = new ProjectFilter(valuesByCategory);
    let report = projectFilter.getFilterReport(projects);

    // Hide cards not satisfying filter, update counts in dropdowns
    function applyFilter(filterReport) {

      // hide projects not satisfying filter constraints
      document.querySelectorAll(".project-card").forEach(element => {
        if (filterReport.ids.indexOf(parseInt(element.id)) < 0) {
          element.setAttribute('class', 'project-card hidden-project');
        } else {
          element.setAttribute('class', 'project-card');
        }
      });


      // Assign updated counts to dropdown text
      for(let category in report.counts) {
        const termCounts = report.counts[category];
        for(let term in termCounts) {
          // const cleanName = `${category}_${term.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '')}`;
          const cleanName = cleanFieldName(category, term);
          const text = `${term} (${termCounts[term]})`;
          document.getElementById(cleanName).innerHTML = text;
        }
      }

    }

    // Render the filter toolbar
    for (let category in report.counts) {

      const termSet = report.counts[category];

      // dropdown container - menu item
      const categoryDropdown = document.createElement('li');
      categoryDropdown.setAttribute('class', 'filter-item');

      // dropdown label/trigger element
      const categoryTitle = document.createElement('a');
      categoryTitle.appendChild(document.createTextNode(category));
      categoryDropdown.appendChild(categoryTitle);

      // dropdown menu
      const termList = document.createElement('ul')
      termList.setAttribute('class', 'dropdown');

      for (let term in termSet) {

        const count = termSet[term];

        const termItem = document.createElement('li');

        const content = document.createElement('div');
        const checkbox = document.createElement('input');
        checkbox.setAttribute('type', 'checkbox');

        const text = `${term} (${count})`;

        const textSpan = document.createElement('span');

        // TODO: Find a better mechanism for indexing dropdown items
        textSpan.setAttribute('id', cleanFieldName(category, term));
        textSpan.innerHTML = text;

        // trigger a new filtering when a checkbox is clicked
        checkbox.addEventListener('input', function (event) {

          if (event.target.checked) {
            projectFilter.addCondition(category, term);
          } else {
            projectFilter.removeCondition(category, term);
          }

          // recompute counts and IDs to hide
          report = projectFilter.getFilterReport(projects);

          applyFilter(report);

        });

        // finalize build UI component
        content.appendChild(checkbox);
        content.appendChild(textSpan);
        termItem.appendChild(content);
        termList.appendChild(termItem);
      }

      // compile DOM node and attach to document tree
      categoryDropdown.appendChild(termList);
      document.querySelector("#filter-list").appendChild(categoryDropdown);

    }

  });




</script>